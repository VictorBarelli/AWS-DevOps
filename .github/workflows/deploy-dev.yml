name: Deploy to Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  ECS_CLUSTER: oracle-devops-dev-cluster

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: development

    strategy:
      matrix:
        service:
          - name: api-gateway
            port: 8080
          - name: auth-service
            port: 8081
          - name: user-service
            port: 8082
          - name: order-service
            port: 8083
          - name: notification-service
            port: 8084

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/oracle-devops-dev-github-actions
          role-session-name: GitHubActions
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image
        id: build
        env:
          ECR_REPOSITORY: oracle-devops-dev-${{ matrix.service.name }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd services/${{ matrix.service.name }}
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service oracle-devops-dev-${{ matrix.service.name }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }} || echo "Service may not exist yet"

  # ===========================================================================
  # Smoke Tests
  # ===========================================================================
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Wait for deployment
        run: sleep 60

      - name: Health Check - API Gateway
        run: |
          curl -f https://api.dev.example.com/health || echo "Health check skipped - endpoint not configured"

  # ===========================================================================
  # Notify
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy, smoke-test]
    if: always()

    steps:
      - name: Notify Success
        if: needs.deploy.result == 'success'
        run: |
          echo "✅ Deployment to dev successful!"
          # Add Slack/Discord notification here

      - name: Notify Failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "❌ Deployment to dev failed!"
          # Add Slack/Discord notification here
