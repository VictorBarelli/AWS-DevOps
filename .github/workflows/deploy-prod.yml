name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
      version:
        description: 'Version/tag to deploy (default: latest)'
        required: false
        default: 'latest'

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  ECS_CLUSTER: oracle-devops-prod-cluster

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm != 'deploy'
        run: |
          echo "‚ùå Deployment not confirmed. Type 'deploy' to proceed."
          exit 1

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    environment: production

    strategy:
      max-parallel: 1  # Deploy one at a time for safety
      matrix:
        service:
          - api-gateway
          - auth-service
          - user-service
          - order-service
          - notification-service

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/oracle-devops-prod-github-actions
          role-session-name: GitHubActions
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag and push production image
        env:
          DEV_REPOSITORY: oracle-devops-dev-${{ matrix.service }}
          PROD_REPOSITORY: oracle-devops-prod-${{ matrix.service }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          # Pull from dev and push to prod
          docker pull $ECR_REGISTRY/$DEV_REPOSITORY:$VERSION
          docker tag $ECR_REGISTRY/$DEV_REPOSITORY:$VERSION $ECR_REGISTRY/$PROD_REPOSITORY:$VERSION
          docker tag $ECR_REGISTRY/$DEV_REPOSITORY:$VERSION $ECR_REGISTRY/$PROD_REPOSITORY:latest
          docker push $ECR_REGISTRY/$PROD_REPOSITORY:$VERSION
          docker push $ECR_REGISTRY/$PROD_REPOSITORY:latest

      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service oracle-devops-prod-${{ matrix.service }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for service stability
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services oracle-devops-prod-${{ matrix.service }} \
            --region ${{ env.AWS_REGION }}

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Notify Team
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "üöÄ Production deployment successful!"
          else
            echo "üî• Production deployment failed!"
          fi
